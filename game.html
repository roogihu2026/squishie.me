<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Speed Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION SECTION ---
        // 1. FOR LOCAL SCORES (Default): You don't need to do anything! It works out of the box.
        // 2. FOR GLOBAL SCORES: Follow the guide I sent, get your keys, and paste them here.
        const firebaseConfig = {
            apiKey: "AIzaSyBhk9m7nWANYisanze2QOpiVgFI1I-EFYQ",
            authDomain: "typing-game-leaderboard-93f1c.firebaseapp.com",
            projectId: "typing-game-leaderboard-93f1c",
            storageBucket: "typing-game-leaderboard-93f1c.firebasestorage.app",
            messagingSenderId: "686410302356",
            appId: "1:686410302356:web:1feae0f20800af14b34581",
            measurementId: "G-Q4FRMZMN3S"
        };
        // -----------------------------

        let db;
        let auth;
        let currentUser;
        let useLocalStorage = true;
        const appId = 'typing-game-leaderboard-v1'; 

        // Initialize DB Strategy
        function initDatabase() {
            // Check if user provided valid config keys
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    useLocalStorage = false;
                    console.log("Connected to Firebase (Global Leaderboard)");
                    
                    signInAnonymously(auth);
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) subscribeToGlobalLeaderboard();
                    });
                } catch (e) {
                    console.warn("Firebase Init Error:", e);
                    initLocalLeaderboard();
                }
            } else {
                // Check if environment provided config (for preview context inside this chat)
                if (typeof __firebase_config !== 'undefined') {
                    try {
                        const app = initializeApp(JSON.parse(__firebase_config));
                        auth = getAuth(app);
                        db = getFirestore(app);
                        useLocalStorage = false; 
                        
                        const initAuth = async () => {
                             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                             } else {
                                await signInAnonymously(auth);
                             }
                        };
                        initAuth();

                        onAuthStateChanged(auth, (user) => {
                            currentUser = user;
                            if (user) subscribeToGlobalLeaderboard();
                        });
                        return;
                    } catch(e) { console.warn("Env config failed", e); }
                }

                console.log("No valid Firebase config found. Using Local Storage.");
                initLocalLeaderboard();
            }
        }

        // --- LEADERBOARD LOGIC (Hybrid) ---

        function initLocalLeaderboard() {
            renderLeaderboard(getLocalScores());
            // Show badge indicating local mode
            const badge = document.getElementById('mode-badge');
            if(badge) {
                badge.innerText = "Local Mode";
                badge.classList.remove('bg-green-100', 'text-green-800');
                badge.classList.add('bg-gray-100', 'text-gray-600');
            }
        }

        function getLocalScores() {
            const stored = localStorage.getItem('typing_game_scores');
            return stored ? JSON.parse(stored) : [];
        }

        function subscribeToGlobalLeaderboard() {
             const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
             onSnapshot(scoresRef, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => scores.push(doc.data()));
                scores.sort((a, b) => b.wpm - a.wpm);
                renderLeaderboard(scores.slice(0, 10));
             });
        }

        function renderLeaderboard(scores) {
            const listElement = document.getElementById('leaderboard-list');
            listElement.innerHTML = '';
            
            if (scores.length === 0) {
                listElement.innerHTML = '<li class="text-center text-gray-400 italic py-4">No scores yet. Be the first!</li>';
                return;
            }

            scores.forEach((score, index) => {
                const isTop3 = index < 3;
                const icon = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `#${index + 1}`;
                
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg ${isTop3 ? 'bg-yellow-50 border border-yellow-100' : 'bg-white border border-gray-100'} shadow-sm mb-2`;
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-8 text-center ${isTop3 ? 'text-yellow-600' : 'text-gray-400'}">${icon}</span>
                        <span class="font-medium text-gray-700 truncate max-w-[120px]">${escapeHtml(score.nickname)}</span>
                    </div>
                    <span class="font-bold text-blue-600">${score.wpm} <span class="text-xs text-gray-400 font-normal">WPM</span></span>
                `;
                listElement.appendChild(li);
            });
        }

        function escapeHtml(text) {
            if (!text) return 'Anonymous';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Exposed function for the UI to call
        window.submitScore = async (nickname, wpm) => {
            const submitBtn = document.getElementById('submit-score-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Saving...';

            try {
                const newScore = {
                    nickname: nickname || 'Anonymous',
                    wpm: wpm,
                    timestamp: new Date().toISOString()
                };

                if (useLocalStorage) {
                    // Local Save
                    const scores = getLocalScores();
                    scores.push(newScore);
                    scores.sort((a, b) => b.wpm - a.wpm);
                    localStorage.setItem('typing_game_scores', JSON.stringify(scores));
                    renderLeaderboard(scores.slice(0, 10));
                    await new Promise(r => setTimeout(r, 500)); // Fake delay for feel
                } else {
                    // Firebase Save
                    if (auth.currentUser) {
                         newScore.uid = auth.currentUser.uid;
                         newScore.timestamp = serverTimestamp();
                         await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), newScore);
                    }
                }
                
                // Success UI
                submitBtn.innerText = 'Saved!';
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                
                setTimeout(() => {
                    document.getElementById('nickname-section').classList.add('hidden');
                    document.getElementById('save-message').classList.remove('hidden');
                }, 1000);

            } catch (e) {
                console.error("Error saving score:", e);
                submitBtn.innerText = 'Error';
                submitBtn.disabled = false;
            }
        };

        // Start everything
        initDatabase();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #f3f4f6;
        }

        .quote-char {
            position: relative;
            transition: color 0.1s ease;
        }

        .quote-char.correct { color: #10b981; }
        .quote-char.incorrect { color: #ef4444; text-decoration: underline; }

        .quote-char.active::before {
            content: '';
            position: absolute; left: 0; bottom: 0;
            width: 100%; height: 3px; background-color: #3b82f6;
            animation: blink 1s infinite;
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        #input-area { position: absolute; opacity: 0; z-index: -10; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .visual-quote { color: #9ca3af; user-select: none; }
        
        /* Custom Scrollbar for leaderboard */
        .leaderboard-scroll::-webkit-scrollbar { width: 6px; }
        .leaderboard-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .leaderboard-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .leaderboard-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 text-gray-800 bg-gradient-to-br from-gray-100 to-blue-50">

    <!-- Navbar/Header -->
    <nav class="w-full max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 pt-4">
        <a href="index.html" class="text-gray-500 hover:text-blue-600 transition mb-4 md:mb-0 text-sm">
            <i class="fas fa-arrow-left mr-2"></i>Back to Home
        </a>
        <h1 class="text-3xl font-bold text-gray-800 tracking-tight">
            Typing Speed Game
        </h1>
        <div class="w-32 hidden md:block"></div> <!-- Spacer for centering -->
    </nav>

    <!-- Main Content Grid -->
    <div class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Game Area (Span 2) -->
        <div class="lg:col-span-2">
            <div class="glass-panel w-full rounded-2xl p-8 relative overflow-hidden h-full flex flex-col justify-between min-h-[500px]">
                
                <!-- Game Header -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex gap-2">
                         <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-gamepad mr-1"></i> Play
                        </span>
                    </div>
                    <div class="text-lg font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-full border border-gray-200 shadow-inner">
                        <i class="fas fa-stopwatch mr-2 text-blue-500"></i><span id="timer">0</span>s
                    </div>
                </div>

                <!-- Game Container -->
                <div class="relative flex-grow flex flex-col justify-center" id="game-container" onclick="focusInput()">
                    <!-- Instructions -->
                    <div id="focus-overlay" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 cursor-pointer transition-opacity duration-200 rounded-lg">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                                <i class="fas fa-mouse-pointer text-2xl"></i>
                            </div>
                            <p class="text-xl text-gray-600 font-bold">Click to Start</p>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-white/95 z-20 hidden rounded-lg">
                        <div class="flex flex-col items-center">
                            <div class="loader mb-3 w-10 h-10 border-4"></div>
                            <p class="text-gray-500 font-medium">Getting a quote...</p>
                        </div>
                    </div>

                    <!-- Quote Text -->
                    <div id="quote-display" class="text-2xl md:text-3xl leading-relaxed font-medium text-gray-400 break-words select-none mb-6 text-center lg:text-left">
                        <!-- Text injected by JS -->
                    </div>
                    
                    <!-- Source -->
                    <div id="quote-source" class="text-sm text-gray-500 italic text-right border-t border-gray-100 pt-3">
                        <!-- Source injected by JS -->
                    </div>

                    <textarea id="input-area" class="w-full h-full" autocomplete="off" spellcheck="false"></textarea>
                </div>

                <!-- Controls -->
                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8 pt-6 border-t border-gray-100">
                    <button onclick="startGame('classic')" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                        <i class="fas fa-film mr-2"></i> Classic
                    </button>
                    <button onclick="startGame('ai')" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-medium shadow-md">
                        <i class="fas fa-sparkles mr-2 text-yellow-300"></i> AI Challenge
                    </button>
                </div>

                <!-- Results Modal (Overlay) -->
                <div id="results-modal" class="absolute inset-0 bg-white/95 backdrop-blur-xl flex flex-col items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300 rounded-2xl">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Finished!</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4 mb-6 text-center w-full max-w-sm">
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <p class="text-xs text-blue-500 font-bold uppercase">Speed</p>
                            <p id="wpm-result" class="text-4xl font-bold text-blue-600">0</p>
                            <p class="text-xs text-blue-400">WPM</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                            <p class="text-xs text-green-500 font-bold uppercase">Accuracy</p>
                            <p id="accuracy-result" class="text-4xl font-bold text-green-600">100%</p>
                            <p class="text-xs text-green-400">Correct</p>
                        </div>
                    </div>

                    <!-- AI Coach -->
                    <div class="w-full max-w-sm bg-indigo-50 border border-indigo-100 rounded-lg p-3 mb-6 text-center">
                        <p class="text-indigo-800 text-xs font-bold uppercase mb-1"><i class="fas fa-robot mr-1"></i> AI Coach</p>
                        <p id="ai-feedback-text" class="text-gray-700 text-sm italic">Analyzing...</p>
                    </div>

                    <!-- Save Score Section -->
                    <div id="nickname-section" class="w-full max-w-sm bg-white border border-gray-200 p-4 rounded-xl shadow-sm mb-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Add to Leaderboard</label>
                        <div class="flex gap-2">
                            <input type="text" id="nickname-input" placeholder="Your Nickname" maxlength="12" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <button id="submit-score-btn" onclick="triggerSaveScore()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold">
                                Save
                            </button>
                        </div>
                    </div>
                    <div id="save-message" class="hidden mb-6 text-green-600 font-bold"><i class="fas fa-check-circle mr-2"></i>Score Saved!</div>

                    <!-- Modal Actions -->
                    <div class="flex gap-3">
                        <button onclick="startGame('classic')" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">Replay</button>
                        <button onclick="startGame('ai')" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 text-sm">Next Quote</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Right Column: Leaderboard (Span 1) -->
        <div class="lg:col-span-1">
            <div class="glass-panel w-full rounded-2xl p-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Top 10</h2>
                    <span id="mode-badge" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold">Global Mode</span>
                </div>
                
                <!-- List Container -->
                <div class="flex-grow overflow-y-auto leaderboard-scroll max-h-[500px] lg:max-h-none">
                    <ul id="leaderboard-list" class="space-y-2">
                        <!-- Loading State -->
                        <div class="flex flex-col gap-2 animate-pulse">
                            <div class="h-12 bg-gray-200 rounded-lg w-full"></div>
                            <div class="h-12 bg-gray-200 rounded-lg w-full"></div>
                            <div class="h-12 bg-gray-200 rounded-lg w-full"></div>
                        </div>
                    </ul>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-400">Scores update automatically</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const apiKey = ""; // API Key
        
        // Quote Data
        const RANDOM_QUOTES = [
            { text: "Life is like a box of chocolates, you never know what you're gonna get.", source: "Forrest Gump (1994)" },
            { text: "To be or not to be, that is the question.", source: "Hamlet (1603)" },
            { text: "May the Force be with you.", source: "Star Wars (1977)" },
            { text: "There's no place like home.", source: "The Wizard of Oz (1939)" },
            { text: "I'm going to make him an offer he can't refuse.", source: "The Godfather (1972)" },
            { text: "You're gonna need a bigger boat.", source: "Jaws (1975)" },
            { text: "Houston, we have a problem.", source: "Apollo 13 (1995)" },
            { text: "Elementary, my dear Watson.", source: "The Adventures of Sherlock Holmes (1939)" },
            { text: "It was the best of times, it was the worst of times.", source: "A Tale of Two Cities (1859)" },
            { text: "All we have to decide is what to do with the time that is given us.", source: "The Fellowship of the Ring (1954)" }
        ];

        // Elements
        const quoteDisplayElement = document.getElementById('quote-display');
        const quoteSourceElement = document.getElementById('quote-source');
        const inputAreaElement = document.getElementById('input-area');
        const timerElement = document.getElementById('timer');
        const focusOverlay = document.getElementById('focus-overlay');
        const resultsModal = document.getElementById('results-modal');
        const wpmResultElement = document.getElementById('wpm-result');
        const accuracyResultElement = document.getElementById('accuracy-result');
        const loadingOverlay = document.getElementById('loading-overlay');
        const aiFeedbackText = document.getElementById('ai-feedback-text');
        
        // Leaderboard Input Elements
        const nicknameSection = document.getElementById('nickname-section');
        const nicknameInput = document.getElementById('nickname-input');
        const saveMessage = document.getElementById('save-message');
        const submitScoreBtn = document.getElementById('submit-score-btn');

        let startTime;
        let timerInterval;
        let currentQuote = { text: "", source: "" };
        let isPlaying = false;
        let hasStartedTyping = false;
        let currentWPM = 0;

        startGame('classic');

        // --- GEMINI API ---
        async function callGemini(prompt) {
            try {
                let retries = 0;
                const maxRetries = 3;
                let delay = 1000;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text.trim();
                    } catch (err) {
                        retries++;
                        if (retries >= maxRetries) throw err;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
            } catch (error) { console.error("Gemini API Error:", error); return null; }
        }

        async function getAIQuote() {
            const prompt = `Generate a JSON object with two keys: "text" and "source". 
            "text" must be a famous, interesting quote from a well-known movie or book, approximately 10-25 words long. 
            "source" must be the Title and Year (e.g. "The Matrix (1999)").
            Do not include quotation marks in the "text" value.`;
            try {
                const text = await callGemini(prompt);
                if (!text) throw new Error("No response");
                return JSON.parse(text);
            } catch (e) {
                return { text: "Error loading AI text. Check connection.", source: "System" };
            }
        }

        async function getAICoachFeedback(wpm) {
            const jsonPrompt = `Return a JSON object with a key "feedback" containing a short, 1-sentence funny or encouraging compliment for someone who typed ${wpm} WPM.`;
            try {
                const text = await callGemini(jsonPrompt);
                const obj = JSON.parse(text);
                return obj.feedback || "Great typing! Keep it up!";
            } catch (e) { return "Great typing! Keep it up!"; }
        }

        // --- GAME LOGIC ---
        async function startGame(mode = 'classic') {
            inputAreaElement.value = '';
            timerElement.innerText = 0;
            clearInterval(timerInterval);
            isPlaying = false;
            hasStartedTyping = false;
            
            resultsModal.classList.add('hidden');
            resultsModal.classList.remove('opacity-100');
            focusOverlay.style.opacity = '1';
            focusOverlay.style.pointerEvents = 'auto';
            
            // Reset Leaderboard Input
            nicknameSection.classList.remove('hidden');
            saveMessage.classList.add('hidden');
            nicknameInput.value = '';
            submitScoreBtn.disabled = false;
            submitScoreBtn.innerText = 'Save';
            submitScoreBtn.classList.add('bg-blue-600');
            submitScoreBtn.classList.remove('bg-green-600');

            if (mode === 'ai') {
                loadingOverlay.classList.remove('hidden');
                currentQuote = await getAIQuote();
                loadingOverlay.classList.add('hidden');
            } else {
                currentQuote = RANDOM_QUOTES[Math.floor(Math.random() * RANDOM_QUOTES.length)];
            }
            renderQuote();
            inputAreaElement.focus(); 
        }

        function renderQuote() {
            quoteDisplayElement.innerHTML = '';
            const openQuote = document.createElement('span');
            openQuote.innerText = '"'; openQuote.className = 'visual-quote mr-1';
            quoteDisplayElement.appendChild(openQuote);

            currentQuote.text.split('').forEach(char => {
                const charSpan = document.createElement('span');
                charSpan.innerText = char;
                charSpan.classList.add('quote-char');
                quoteDisplayElement.appendChild(charSpan);
            });

            const closeQuote = document.createElement('span');
            closeQuote.innerText = '"'; closeQuote.className = 'visual-quote ml-1';
            quoteDisplayElement.appendChild(closeQuote);
            quoteSourceElement.innerText = currentQuote.source ? `- ${currentQuote.source}` : '';
        }

        function focusInput() {
            inputAreaElement.focus();
            if (!hasStartedTyping && !loadingOverlay.classList.contains('hidden')) return;
            if (!hasStartedTyping) {
                focusOverlay.style.opacity = '0';
                focusOverlay.style.pointerEvents = 'none';
            }
        }

        inputAreaElement.addEventListener('input', () => {
            if (!hasStartedTyping && inputAreaElement.value.length > 0) {
                hasStartedTyping = true; isPlaying = true; startTimer();
                focusOverlay.style.opacity = '0';
            }
            const arrayQuote = quoteDisplayElement.querySelectorAll('.quote-char');
            const arrayValue = inputAreaElement.value.split('');
            let allCorrectSoFar = true;

            arrayQuote.forEach((characterSpan, index) => {
                const character = arrayValue[index];
                characterSpan.classList.remove('active');
                if (character == null) {
                    characterSpan.classList.remove('correct', 'incorrect');
                    allCorrectSoFar = false;
                    if (index === arrayValue.length) characterSpan.classList.add('active');
                } else if (character === characterSpan.innerText) {
                    characterSpan.classList.add('correct');
                    characterSpan.classList.remove('incorrect');
                } else {
                    characterSpan.classList.remove('correct');
                    characterSpan.classList.add('incorrect');
                    allCorrectSoFar = false;
                }
            });

            if (arrayValue.length === currentQuote.text.length && allCorrectSoFar) endGame();
        });

        inputAreaElement.addEventListener('blur', () => {
            if (hasStartedTyping && isPlaying) {
                focusOverlay.style.opacity = '1';
                focusOverlay.querySelector('p').innerText = "Click to resume";
            }
        });
        inputAreaElement.addEventListener('focus', () => { focusOverlay.style.opacity = '0'; });

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(() => { if(isPlaying) timerElement.innerText = getTimerTime(); }, 1000);
        }

        function getTimerTime() { return Math.floor((new Date() - startTime) / 1000); }

        function endGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            
            const timeTaken = getTimerTime();
            const wordCount = currentQuote.text.length / 5;
            const minutes = timeTaken / 60;
            currentWPM = minutes > 0 ? Math.round(wordCount / minutes) : 0;
            
            wpmResultElement.innerText = currentWPM;
            resultsModal.classList.remove('hidden');
            setTimeout(() => { resultsModal.classList.add('opacity-100'); }, 10);

            aiFeedbackText.innerHTML = '<span class="loader w-4 h-4 border-2"></span> Analyzing...';
            getAICoachFeedback(currentWPM).then(feedback => { aiFeedbackText.innerText = feedback; });
        }

        function triggerSaveScore() {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                alert("Please enter a nickname!");
                return;
            }
            window.submitScore(nickname, currentWPM);
        }
    </script>
</body>
</html>
